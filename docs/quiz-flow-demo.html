<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Quiz System - Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .quiz-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b35;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #fff3f0;
            border-radius: 8px;
            border: 2px solid #ffcab0;
        }
        
        .progress {
            margin: 20px 0;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .question-container {
            margin: 30px 0;
            padding: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }
        
        .question-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        
        .option {
            margin: 10px 0;
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .option:hover {
            border-color: #4CAF50;
            background: #f9f9f9;
        }
        
        .option.selected {
            border-color: #4CAF50;
            background: #e8f5e8;
        }
        
        .option input {
            margin-right: 10px;
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            padding: 12px 25px;
            margin: 0 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .results {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .score {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .status-message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .config-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="quiz-header">
            <h1>üéØ Class Quiz System Demo</h1>
            <p>Complete quiz flow demonstration using the Class Quiz APIs</p>
        </div>

        <!-- Configuration Form -->
        <div id="configForm" class="config-form">
            <h3>Configuration</h3>
            <div class="form-group">
                <label for="accessToken">Access Token:</label>
                <input type="text" id="accessToken" placeholder="Your JWT access token">
            </div>
            <div class="form-group">
                <label for="campusId">Campus ID:</label>
                <input type="text" id="campusId" value="c78c27ef-832f-4758-a3db-79971c6aa9d5">
            </div>
            <div class="form-group">
                <label for="classId">Class ID:</label>
                <input type="text" id="classId" value="22a6e0a4-8c75-40fc-9c28-1768d0c8310a">
            </div>
            <div class="form-group">
                <label for="userId">User ID:</label>
                <input type="text" id="userId" value="57ddb842-f034-40c8-9bb2-d3714371a9ea">
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="initializeQuiz()">Initialize Quiz System</button>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message hidden"></div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>

        <!-- Quiz Selection -->
        <div id="quizSelection" class="hidden">
            <h3>üìö Select a Quiz</h3>
            <div id="quizList"></div>
            <div class="controls">
                <button class="btn btn-secondary" onclick="createSampleQuiz()">Create Sample Quiz</button>
            </div>
        </div>

        <!-- Quiz Interface -->
        <div id="quizInterface" class="hidden">
            <div class="timer" id="timer">‚è∞ Time Remaining: --:--</div>
            
            <div class="progress">
                <span id="progressText">Question 1 of 3</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="question-container">
                <div class="question-text" id="questionText">Loading question...</div>
                <div id="optionsContainer"></div>
            </div>

            <div class="controls">
                <button class="btn btn-secondary" id="previousBtn" onclick="previousQuestion()" disabled>Previous</button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">Next</button>
                <button class="btn btn-primary" id="submitBtn" onclick="completeQuiz()" style="display: none;">Submit Quiz</button>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsContainer" class="hidden">
            <div class="results">
                <h2>üéâ Quiz Completed!</h2>
                <div class="score" id="finalScore">--</div>
                <div id="resultDetails"></div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="resetQuiz()">Take Another Quiz</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BASE_URL = 'http://localhost:4500';
        let config = {};
        let currentQuiz = null;
        let currentSession = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let answers = {};
        let timer = null;

        // Utility Functions
        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.classList.remove('hidden');
            
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        function showLoading(show = true) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function hideAllSections() {
            ['configForm', 'quizSelection', 'quizInterface', 'resultsContainer'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }

        // API Functions
        async function apiCall(endpoint, options = {}) {
            const url = endpoint.startsWith('http') ? endpoint : `${BASE_URL}${endpoint}`;
            
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.accessToken}`
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });
            
            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorData}`);
            }

            return await response.json();
        }

        // Initialize Quiz System
        async function initializeQuiz() {
            try {
                // Get configuration
                config = {
                    accessToken: document.getElementById('accessToken').value.trim(),
                    campusId: document.getElementById('campusId').value.trim(),
                    classId: document.getElementById('classId').value.trim(),
                    userId: document.getElementById('userId').value.trim()
                };

                if (!config.accessToken) {
                    showStatus('Please enter your access token', 'error');
                    return;
                }

                showLoading(true);

                // Test API connection
                await fetch(`${BASE_URL}/health`);
                showStatus('Connected to quiz system successfully!');

                // Load available quizzes
                await loadQuizzes();

                hideAllSections();
                document.getElementById('quizSelection').classList.remove('hidden');

            } catch (error) {
                showStatus(`Failed to initialize: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Load Available Quizzes
        async function loadQuizzes() {
            try {
                const quizzes = await apiCall(`/api/class-quiz/class/${config.classId}`);
                
                const quizListEl = document.getElementById('quizList');
                quizListEl.innerHTML = '';

                if (quizzes.length === 0) {
                    quizListEl.innerHTML = '<p>No quizzes available. Create a sample quiz to get started.</p>';
                    return;
                }

                quizzes.forEach(quiz => {
                    const quizEl = document.createElement('div');
                    quizEl.className = 'option';
                    quizEl.innerHTML = `
                        <h4>${quiz.quiz_name}</h4>
                        <p>${quiz.quiz_description}</p>
                        <small>Created: ${new Date(quiz.created_at).toLocaleDateString()}</small>
                    `;
                    quizEl.onclick = () => startQuizSession(quiz);
                    quizListEl.appendChild(quizEl);
                });

            } catch (error) {
                showStatus(`Failed to load quizzes: ${error.message}`, 'error');
            }
        }

        // Create Sample Quiz
        async function createSampleQuiz() {
            try {
                showLoading(true);

                // Create quiz
                const quizData = {
                    quiz_name: "Sample Mathematics Quiz",
                    quiz_description: "A demonstration quiz with basic math questions",
                    quiz_meta_data: {
                        time_limit_minutes: 5,
                        shuffle_questions: true,
                        allow_review: true,
                        show_results_immediately: true,
                        max_attempts: 1
                    }
                };

                const quiz = await apiCall(`/api/class-quiz/${config.classId}`, {
                    method: 'POST',
                    body: JSON.stringify(quizData)
                });

                // Add questions
                const questionsData = {
                    questionBank: [
                        {
                            question_text: "What is 15 + 7?",
                            question_type: "multiple_choice",
                            options: ["20", "22", "24", "26"],
                            correct_answer: "22",
                            meta_data: { difficulty: "easy" }
                        },
                        {
                            question_text: "What is 8 √ó 9?",
                            question_type: "multiple_choice",
                            options: ["63", "72", "81", "90"],
                            correct_answer: "72",
                            meta_data: { difficulty: "medium" }
                        },
                        {
                            question_text: "What is ‚àö64?",
                            question_type: "multiple_choice",
                            options: ["6", "7", "8", "9"],
                            correct_answer: "8",
                            meta_data: { difficulty: "medium" }
                        }
                    ]
                };

                await apiCall(`/api/class-quiz/${config.classId}/${quiz.id}/questions`, {
                    method: 'POST',
                    body: JSON.stringify(questionsData)
                });

                showStatus('Sample quiz created successfully!');
                await loadQuizzes();

            } catch (error) {
                showStatus(`Failed to create sample quiz: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Start Quiz Session
        async function startQuizSession(quiz) {
            try {
                showLoading(true);
                currentQuiz = quiz;

                // Start session
                const sessionData = await apiCall(`/api/class-quiz/session/${config.classId}/${quiz.id}/start`, {
                    method: 'POST'
                });

                currentSession = sessionData.data.session;
                questions = await apiCall(`/api/class-quiz/class/${config.classId}/${quiz.id}/questions`);
                
                currentQuestionIndex = 0;
                answers = {};

                hideAllSections();
                document.getElementById('quizInterface').classList.remove('hidden');

                displayQuestion();
                startTimer();

                showStatus('Quiz started! Good luck!');

            } catch (error) {
                showStatus(`Failed to start quiz: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Display Current Question
        function displayQuestion() {
            if (!questions || questions.length === 0) return;

            const question = questions[currentQuestionIndex];
            document.getElementById('questionText').textContent = question.question_text;

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const optionEl = document.createElement('div');
                optionEl.className = 'option';
                optionEl.innerHTML = `
                    <input type="radio" name="answer" value="${option}" id="option${index}">
                    <label for="option${index}">${option}</label>
                `;

                // Check if this option was previously selected
                if (answers[question.id] === option) {
                    optionEl.classList.add('selected');
                    optionEl.querySelector('input').checked = true;
                }

                optionEl.onclick = () => selectOption(question.id, option, optionEl);
                optionsContainer.appendChild(optionEl);
            });

            updateProgress();
            updateNavigation();
        }

        // Select Option
        async function selectOption(questionId, answer, optionEl) {
            try {
                // Update UI
                document.querySelectorAll('.option').forEach(el => el.classList.remove('selected'));
                optionEl.classList.add('selected');
                optionEl.querySelector('input').checked = true;

                // Save answer locally
                answers[questionId] = answer;

                // Submit answer to API
                await apiCall(`/api/class-quiz/session/${currentSession.session_token}/answer`, {
                    method: 'POST',
                    body: JSON.stringify({
                        question_id: questionId,
                        answer: answer
                    })
                });

                showStatus('Answer saved!', 'success');

            } catch (error) {
                if (error.message.includes('expired')) {
                    showStatus('Quiz session has expired!', 'error');
                    await handleSessionExpired();
                } else {
                    showStatus(`Failed to save answer: ${error.message}`, 'error');
                }
            }
        }

        // Navigation
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function updateNavigation() {
            document.getElementById('previousBtn').disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === questions.length - 1) {
                document.getElementById('nextBtn').style.display = 'none';
                document.getElementById('submitBtn').style.display = 'inline-block';
            } else {
                document.getElementById('nextBtn').style.display = 'inline-block';
                document.getElementById('submitBtn').style.display = 'none';
            }
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = 
                `Question ${currentQuestionIndex + 1} of ${questions.length}`;
        }

        // Timer Management
        function startTimer() {
            if (timer) clearInterval(timer);

            timer = setInterval(async () => {
                try {
                    const sessionData = await apiCall(`/api/class-quiz/session/${currentSession.session_token}`);
                    const timeRemaining = sessionData.data.time_remaining_seconds;

                    updateTimerDisplay(timeRemaining);

                    if (timeRemaining <= 0) {
                        clearInterval(timer);
                        showStatus('Time\'s up! Quiz auto-submitted.', 'warning');
                        await handleSessionExpired();
                    }

                } catch (error) {
                    if (error.message.includes('expired')) {
                        clearInterval(timer);
                        await handleSessionExpired();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('timer').textContent = 
                `‚è∞ Time Remaining: ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Complete Quiz
        async function completeQuiz() {
            try {
                showLoading(true);

                const result = await apiCall(`/api/class-quiz/session/${currentSession.session_token}/complete`, {
                    method: 'POST'
                });

                displayResults(result.data);

            } catch (error) {
                showStatus(`Failed to complete quiz: ${error.message}`, 'error');
            } finally {
                showLoading(false);
                if (timer) clearInterval(timer);
            }
        }

        // Handle Session Expired
        async function handleSessionExpired() {
            if (timer) clearInterval(timer);
            
            showStatus('Quiz session has expired and been auto-submitted', 'warning');
            
            // Try to get the auto-submitted results
            try {
                // You might want to implement a way to retrieve auto-submitted results
                showStatus('Quiz was automatically submitted due to timeout', 'warning');
                resetQuiz();
            } catch (error) {
                resetQuiz();
            }
        }

        // Display Results
        function displayResults(resultData) {
            hideAllSections();
            document.getElementById('resultsContainer').classList.remove('hidden');

            document.getElementById('finalScore').textContent = 
                `${resultData.score}/${resultData.total_questions}`;

            const details = `
                <p><strong>Percentage:</strong> ${resultData.percentage.toFixed(1)}%</p>
                <p><strong>Correct Answers:</strong> ${resultData.correct_answers}</p>
                <p><strong>Incorrect Answers:</strong> ${resultData.incorrect_answers}</p>
                <p><strong>Time Taken:</strong> ${Math.floor(resultData.time_taken_seconds / 60)}:${(resultData.time_taken_seconds % 60).toString().padStart(2, '0')}</p>
            `;

            document.getElementById('resultDetails').innerHTML = details;

            showStatus('Quiz completed successfully!', 'success');
        }

        // Reset Quiz
        function resetQuiz() {
            if (timer) clearInterval(timer);
            
            currentQuiz = null;
            currentSession = null;
            questions = [];
            currentQuestionIndex = 0;
            answers = {};

            hideAllSections();
            document.getElementById('quizSelection').classList.remove('hidden');
            
            loadQuizzes();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Pre-fill with sample token if available
            const sampleToken = 'eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiY2UyYjU5YWUtMzVkYS00MzE4LTk1MWEtMDFkNGE2MWUwYjc3IiwidXNlcl90eXBlIjoiQWRtaW4iLCJzZXNzaW9uX2lkIjoiZjRlYWNlMTUzOTA2NWE0NGE2NDMzODY4ZWE2Nzc4MWIiLCJleHAiOjE3NTE2NTgyMjd9.3aglPpqN5wYxwIUMQSomfrfrcyaJ8QxNArNcMmdXd73siGJikYH8Bo0RRyWG4QLaCPqaXptQUbTx7eAjdxVTvQ';
            document.getElementById('accessToken').value = sampleToken;
        });
    </script>
</body>
</html>
